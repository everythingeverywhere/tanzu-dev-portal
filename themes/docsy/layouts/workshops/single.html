{{ define "main" }}
<script>
const workshopInUseMessage =  '<span class="fa fa-unlink"></span> All Workshops in use. Please Try again later'
var t = 500;
var max = 10;

function rejectDelay(reason) {
  return new Promise((resolve, reject) => {
    setTimeout(reject.bind(null, reason), t);
  });
}

var p = Promise.reject();
for (var i = 0; i < max; i++) {
  p = p.catch(attempt).catch(rejectDelay);
}
p = p.then(processResult).catch(errorHandler);

async function attempt() {
  const response = await fetch('https://pgtm-tbritten.uc.r.appspot.com/api/available/{{ .Params.portal_num }}/{{ .Params.lab }}', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
	  });
  const myJson = await response.json()
  console.log(myJson)
  if (myJson.available >= 1) {
    return true
  } else if (myJson.space < 1){
    return false;
  } else {
    throw "NO SESSIONS"
  }
}
function processResult(res) {
  if (res){
  	document.getElementById('myButton').innerHTML = '<span class="fa fa-cog"></span> Start Workshop'
	document.getElementById('myButton').className = 'btn'
	} else {
	document.getElementById('myButton').innerHTML = workshopInUseMessage
	}
}
function errorHandler(err) {
  document.getElementById('myButton').innerHTML = workshopInUseMessage
}
</script>
<div class="td-main ">
	<div class="bg-gray-dark mt-lg-5 mt-0 py-lg-5 py-2">
		<div class='container'>
			{{ if not .Site.Params.ui.breadcrumb_disable }}{{ partial "breadcrumb.html" . }}{{ end }}
			<h1>{{ .Title }}</h1>
			<p>{{ .Description }}</p>
			<p>Approximate time: {{ .Params.length }} minutes</p>
			<div class="short-gradient-line mb-4"></div>
			<!-- {{ .Params.tags }} -->
			<a href="https://pgtm-tbritten.uc.r.appspot.com/api/workshop/{{ .Params.portal_num }}/{{ .Params.lab }}" class="btn disabled" role="button" id="myButton" ><span class="fa fa-hourglass-half"></span> Checking for available Workshops..</a>

		</div>
	</div>
	<div class="container py-5">
			{{ with $img := .Params.logo }}
		<img src={{ $img | safeURL }} width="50" height="50"  Hspace="10" Vspace="5" align="left"/>
		{{end}}
		<div class="github-imported-sample">
				{{ .Content }}
		</div>

		{{ if (and (not .Params.hide_feedback) (.Site.Params.ui.feedback.enable) (.Site.GoogleAnalytics)) }}
			{{ partial "feedback.html" .Site.Params.ui.feedback }}
			<br />
		{{ end }}
		{{ if (.Site.DisqusShortname) }}
			<br />
			{{ partial "disqus-comment.html" . }}
		{{ end }}
		<div class="text-muted mt-5 pt-3">{{ partial "page-meta-lastmod.html" . }}</div>
	</div>
</div>
{{ end }}
